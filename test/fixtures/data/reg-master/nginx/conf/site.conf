
upstream register_server {
  server register:9000;
}

upstream mail_server {
  server mail:9000 max_fails=3 fail_timeout=30s;
}

upstream leader_server {
  server config-leader:7000 max_fails=3 fail_timeout=30s;
}

upstream admin_panel_server {
  server admin_panel:80;
}

upstream grafana_server {
  server grafana:3000 max_fails=3 fail_timeout=30s;
}

upstream loki_server {
  server loki:3100 max_fails=3 fail_timeout=30s;
}

# Lead server
server {
  listen               443 ssl;
  server_name          lead.DOMAIN;

  access_log /app/log/leader.log default;

  client_max_body_size  5M;

  ### Proxy options (has to be within server definition to be effective)
  proxy_set_header  X-Real-IP  $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto https;
  proxy_redirect    off;
  # Buffering
  proxy_buffering off;
  proxy_buffers 16 8k;

  location / {
    proxy_pass http://leader_server;
  }

}

# Admin panel server
server {
  listen               443 ssl;
  server_name          adm.DOMAIN;

  access_log /app/log/admin-panel.log default;

  client_max_body_size  5M;

  ### Proxy options (has to be within server definition to be effective)
  proxy_set_header  X-Real-IP  $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto https;
  proxy_redirect    off;
  # Buffering
  proxy_buffering off;
  proxy_buffers 16 8k;

  location / {
    proxy_pass http://admin_panel_server;
  }
}

# Mail server
server {
  listen               443 ssl;
  server_name          mail.DOMAIN;

  access_log /app/log/mail.log default;

  client_max_body_size  5M;

  ### Proxy options (has to be within server definition to be effective)
  proxy_set_header  X-Real-IP  $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto https;
  proxy_redirect    off;
  # Buffering
  proxy_buffering off;
  proxy_buffers 16 8k;

  location /sendmail/ {
    proxy_pass http://mail_server;
  }

}

# Grafana server
server {
  listen               443 ssl;
  server_name          graf.DOMAIN;

  access_log /app/log/grafana.log default;

  client_max_body_size  5M;

  ### Proxy options (has to be within server definition to be effective)
  proxy_set_header  X-Real-IP  $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto https;
  proxy_redirect    off;
  # Buffering
  proxy_buffering off;
  proxy_buffers 16 8k;

  location / {
    proxy_pass http://grafana_server;
  }

}

# Loki server
server {
  listen               443 ssl;
  server_name          loki.DOMAIN;

  access_log /app/log/loki.log default;

  auth_basic "Loki auth";
  auth_basic_user_file /app/conf/secret/lokipassword;

  client_max_body_size  5M;

  ### Proxy options (has to be within server definition to be effective)
  proxy_set_header  X-Real-IP  $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto https;
  proxy_redirect    off;
  # Buffering
  proxy_buffering off;
  proxy_buffers 16 8k;

  location / {
    proxy_pass http://loki_server;
  }
}

# Register
server {
  listen               443 ssl;
  server_name          *.DOMAIN;

  access_log /app/log/register.log default;
  access_log /app/log/json_access.log json_analytics;

  client_max_body_size  5M;

  ### Proxy options (has to be within server definition to be effective)
  proxy_set_header  X-Real-IP  $remote_addr;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto https;
  proxy_redirect    off;
  # Buffering
  proxy_buffering off;
  proxy_buffers 16 8k;

  location / {
    proxy_pass http://register_server;  
  }

}

# redirect HTTP to HTTPS
server {
 listen              80;
 return 301 https://$host$request_uri;
}
