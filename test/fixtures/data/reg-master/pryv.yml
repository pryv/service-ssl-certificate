version: '3.5'
services:
  reverse_proxy: 
    image: "eu.gcr.io/pryvio/nginx:1.3.40"
    container_name: pryvio_nginx
    networks: 
      - frontend
    ports: 
      - "443:443"
      - "80:80"
    volumes: 
      - ${PRYV_CONF_ROOT}/pryv/nginx/conf/:/app/conf/:ro
      - ${PRYV_CONF_ROOT}/pryv/nginx/log/:/app/log/
    links:
      - register
      - loki
      - grafana
    restart: always

  admin_panel: 
    image: "eu.gcr.io/pryvio/app-web-admin:1.1.2"
    container_name: pryvio_admin_panel
    networks: 
      - frontend
    restart: always

  register: 
    image: "eu.gcr.io/pryvio/register:1.6.3"
    container_name: pryvio_register
    networks: 
      - frontend
      - backend
    volumes: 
      - ${PRYV_CONF_ROOT}/pryv/register/conf/:/app/conf/:ro
      - ${PRYV_CONF_ROOT}/pryv/register/log/:/app/log/
    links: 
      - redis
    restart: always
    hostname: "$HOSTNAME"

  dns: 
    image: "eu.gcr.io/pryvio/dns:1.6.3"
    container_name: pryvio_dns
    ports: 
      - "REG_MASTER_IP_ADDRESS:53:5353/udp"
    networks: 
      - frontend
      - backend
    volumes: 
      - ${PRYV_CONF_ROOT}/pryv/dns/conf/:/app/conf/:ro
      - ${PRYV_CONF_ROOT}/pryv/dns/log/:/app/log/
    links: 
      - redis
    restart: always
    hostname: "$HOSTNAME"

  redis: 
    image: "eu.gcr.io/pryvio/redis:1.3.40"
    container_name: pryvio_redis
    networks: 
      - backend
    #ports:  # used if reg-slave is defined
    #  - "REG_MASTER_VPN_IP_ADDRESS:6379:6379"
    volumes: 
      - ${PRYV_CONF_ROOT}/pryv/redis/conf/:/app/conf/:ro
      - ${PRYV_CONF_ROOT}/pryv/redis/data/:/app/data/
      - ${PRYV_CONF_ROOT}/pryv/redis/log/:/app/log/
    restart: always

  mail: 
    image: "eu.gcr.io/pryvio/mail:1.2.3"
    container_name: pryvio_mail
    networks: 
      - frontend
    volumes: 
      - ${PRYV_CONF_ROOT}/pryv/mail/conf/:/app/conf/:ro
      - ${PRYV_CONF_ROOT}/pryv/mail/templates/:/app/bin/templates/:ro
    restart: always

  promtail:
    container_name: pryvio_promtail
    image: grafana/promtail:2.0.0
    volumes:
      - ${PRYV_CONF_ROOT}/pryv/nginx/log:/var/log:ro
      - ${PRYV_CONF_ROOT}/pryv/promtail/conf:/var/conf:ro
    command: -config.file=/var/conf/promtail.yaml
    networks:
      - frontend

  loki:
    container_name: pryvio_loki
    image: grafana/loki:2.0.0
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - frontend

  grafana:
    container_name: pryvio_grafana
    image: grafana/grafana:latest
    volumes:
      - ${PRYV_CONF_ROOT}/pryv/grafana:/var/lib/grafana
    networks:
      - frontend

networks:
  frontend:
    driver: bridge
    name: pryv_frontend
  backend:
    driver: bridge
    name: pryv_backend
